#include <stdint.h>
#include <x86intrin.h>
#include <string.h>

#include "common.h"

typedef union u8TrieData
{
    uint64_t bitmap;
    uint8_t bytes[8];
} u8tdata_t;

typedef struct u8TrieNode
{
    uint32_t offset;
    u8tdata_t data;
} u8tnode_t;

#define U8SET(byte) | 1ULL << (byte & 0b00111111)

const u8tnode_t u8UpperTrie[] = 
{
    { /* root */ .offset = 1, .data = { .bitmap = 0UL U8SET(0xF0) } },
    { /* 0xF0 */ .offset = 2, .data = { .bitmap = 0UL U8SET(0x9E) } },
    { /* 0x9E */ .offset = 3, .data = { .bitmap = 0UL U8SET(0xA4) U8SET(0xA5) } },
    { /* 0xA4 */ .offset = 5, .data = { .bitmap = 0UL U8SET(0xA2) U8SET(0xA3) U8SET(0xA4) U8SET(0xA5) U8SET(0xA6) U8SET(0xA7) U8SET(0xA8) U8SET(0xA9) U8SET(0xAA) U8SET(0xAB) U8SET(0xAC) U8SET(0xAD) U8SET(0xAE) U8SET(0xAF) U8SET(0xB0) U8SET(0xB1) U8SET(0xB2) U8SET(0xB3) U8SET(0xB4) U8SET(0xB5) U8SET(0xB6) U8SET(0xB7) U8SET(0xB8) U8SET(0xB9) U8SET(0xBA) U8SET(0xBB) U8SET(0xBC) U8SET(0xBD) U8SET(0xBE) U8SET(0xBF) } },
    { /* 0xA5 */ .offset = 35, .data = { .bitmap = 0UL U8SET(0x80) U8SET(0x81) U8SET(0x82) U8SET(0x83) } },
    { /* 0xA2 */ .offset = 0, .data = { .bytes = { 0xF0, 0x9E, 0xA4, 0x80, 0x00, 0x00, 0x00, 0x04 } } },
    { /* 0xA3 */ .offset = 0, .data = { .bytes = { 0xF0, 0x9E, 0xA4, 0x81, 0x00, 0x00, 0x00, 0x04 } } },
    { /* 0xA4 */ .offset = 0, .data = { .bytes = { 0xF0, 0x9E, 0xA4, 0x82, 0x00, 0x00, 0x00, 0x04 } } },
    { /* 0xA5 */ .offset = 0, .data = { .bytes = { 0xF0, 0x9E, 0xA4, 0x83, 0x00, 0x00, 0x00, 0x04 } } },
    { /* 0xA6 */ .offset = 0, .data = { .bytes = { 0xF0, 0x9E, 0xA4, 0x84, 0x00, 0x00, 0x00, 0x04 } } },
    { /* 0xA7 */ .offset = 0, .data = { .bytes = { 0xF0, 0x9E, 0xA4, 0x85, 0x00, 0x00, 0x00, 0x04 } } },
    { /* 0xA8 */ .offset = 0, .data = { .bytes = { 0xF0, 0x9E, 0xA4, 0x86, 0x00, 0x00, 0x00, 0x04 } } },
    { /* 0xA9 */ .offset = 0, .data = { .bytes = { 0xF0, 0x9E, 0xA4, 0x87, 0x00, 0x00, 0x00, 0x04 } } },
    { /* 0xAA */ .offset = 0, .data = { .bytes = { 0xF0, 0x9E, 0xA4, 0x88, 0x00, 0x00, 0x00, 0x04 } } },
    { /* 0xAB */ .offset = 0, .data = { .bytes = { 0xF0, 0x9E, 0xA4, 0x89, 0x00, 0x00, 0x00, 0x04 } } },
    { /* 0xAC */ .offset = 0, .data = { .bytes = { 0xF0, 0x9E, 0xA4, 0x8A, 0x00, 0x00, 0x00, 0x04 } } },
    { /* 0xAD */ .offset = 0, .data = { .bytes = { 0xF0, 0x9E, 0xA4, 0x8B, 0x00, 0x00, 0x00, 0x04 } } },
    { /* 0xAE */ .offset = 0, .data = { .bytes = { 0xF0, 0x9E, 0xA4, 0x8C, 0x00, 0x00, 0x00, 0x04 } } },
    { /* 0xAF */ .offset = 0, .data = { .bytes = { 0xF0, 0x9E, 0xA4, 0x8D, 0x00, 0x00, 0x00, 0x04 } } },
    { /* 0xB0 */ .offset = 0, .data = { .bytes = { 0xF0, 0x9E, 0xA4, 0x8E, 0x00, 0x00, 0x00, 0x04 } } },
    { /* 0xB1 */ .offset = 0, .data = { .bytes = { 0xF0, 0x9E, 0xA4, 0x8F, 0x00, 0x00, 0x00, 0x04 } } },
    { /* 0xB2 */ .offset = 0, .data = { .bytes = { 0xF0, 0x9E, 0xA4, 0x90, 0x00, 0x00, 0x00, 0x04 } } },
    { /* 0xB3 */ .offset = 0, .data = { .bytes = { 0xF0, 0x9E, 0xA4, 0x91, 0x00, 0x00, 0x00, 0x04 } } },
    { /* 0xB4 */ .offset = 0, .data = { .bytes = { 0xF0, 0x9E, 0xA4, 0x92, 0x00, 0x00, 0x00, 0x04 } } },
    { /* 0xB5 */ .offset = 0, .data = { .bytes = { 0xF0, 0x9E, 0xA4, 0x93, 0x00, 0x00, 0x00, 0x04 } } },
    { /* 0xB6 */ .offset = 0, .data = { .bytes = { 0xF0, 0x9E, 0xA4, 0x94, 0x00, 0x00, 0x00, 0x04 } } },
    { /* 0xB7 */ .offset = 0, .data = { .bytes = { 0xF0, 0x9E, 0xA4, 0x95, 0x00, 0x00, 0x00, 0x04 } } },
    { /* 0xB8 */ .offset = 0, .data = { .bytes = { 0xF0, 0x9E, 0xA4, 0x96, 0x00, 0x00, 0x00, 0x04 } } },
    { /* 0xB9 */ .offset = 0, .data = { .bytes = { 0xF0, 0x9E, 0xA4, 0x97, 0x00, 0x00, 0x00, 0x04 } } },
    { /* 0xBA */ .offset = 0, .data = { .bytes = { 0xF0, 0x9E, 0xA4, 0x98, 0x00, 0x00, 0x00, 0x04 } } },
    { /* 0xBB */ .offset = 0, .data = { .bytes = { 0xF0, 0x9E, 0xA4, 0x99, 0x00, 0x00, 0x00, 0x04 } } },
    { /* 0xBC */ .offset = 0, .data = { .bytes = { 0xF0, 0x9E, 0xA4, 0x9A, 0x00, 0x00, 0x00, 0x04 } } },
    { /* 0xBD */ .offset = 0, .data = { .bytes = { 0xF0, 0x9E, 0xA4, 0x9B, 0x00, 0x00, 0x00, 0x04 } } },
    { /* 0xBE */ .offset = 0, .data = { .bytes = { 0xF0, 0x9E, 0xA4, 0x9C, 0x00, 0x00, 0x00, 0x04 } } },
    { /* 0xBF */ .offset = 0, .data = { .bytes = { 0xF0, 0x9E, 0xA4, 0x9D, 0x00, 0x00, 0x00, 0x04 } } },
    { /* 0x80 */ .offset = 0, .data = { .bytes = { 0xF0, 0x9E, 0xA4, 0x9E, 0x00, 0x00, 0x00, 0x04 } } },
    { /* 0x81 */ .offset = 0, .data = { .bytes = { 0xF0, 0x9E, 0xA4, 0x9F, 0x00, 0x00, 0x00, 0x04 } } },
    { /* 0x82 */ .offset = 0, .data = { .bytes = { 0xF0, 0x9E, 0xA4, 0xA0, 0x00, 0x00, 0x00, 0x04 } } },
    { /* 0x83 */ .offset = 0, .data = { .bytes = { 0xF0, 0x9E, 0xA4, 0xA1, 0x00, 0x00, 0x00, 0x04 } } },
};

_export int32_t u8TrieSearch(const uint8_t *data, uint8_t *destination)
{
    const u8tnode_t *root = u8UpperTrie;

    const u8tnode_t *node = root;

    while (*data)
    {
        uint8_t byte = *data++ & 0b00111111;

        uint64_t bitmap = node->data.bitmap;

        if (!((bitmap >> byte) & 1ULL)) break;

        uint64_t count = _mm_popcnt_u64(bitmap & ((1ULL << byte) - 1));

        node = &root[node->offset + count];
    }

    if (!node->offset)
    {
        memcpy(destination, node->data.bytes, 4);

        return (int32_t)node->data.bytes[7];
    }

    return 0;
}
